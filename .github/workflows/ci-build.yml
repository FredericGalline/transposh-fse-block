name: ðŸ§± WordPress Build â€“ Blocs Gutenberg

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-blocks:
    name: ðŸ”¨ Build des blocs Gutenberg
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: ðŸ”Ž Trouver les dossiers de blocs
        id: list-blocks
        run: |
          echo "dirs=$(find blocks -type f -name package.json -exec dirname {} \; | paste -sd ' ' -)" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'

      - name: ðŸ“š Installer les dÃ©pendances globales
        run: |
          npm install -g @wordpress/scripts @wordpress/icons

      - name: ðŸ§¶ Installer et builder chaque bloc
        run: |
          for dir in ${{ steps.list-blocks.outputs.dirs }}; do
            echo "ðŸ“¦ Traitement de $dir"
            cd "$dir"
            # Ajouter @wordpress/icons aux dÃ©pendances
            if ! grep -q "@wordpress/icons" package.json; then
              npm install --save @wordpress/icons
            fi
            npm ci || npm install
            npm run build
            cd - > /dev/null
          done
